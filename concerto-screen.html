<!-- 
  The `concerto-screen` element provides the main Concerto screen 
-->
<dom-module id="concerto-screen">

  <style>
    :host {
      display: block;
      position: relative;
      width: 100%;
      height: 100%;
    }
    .position {
      position: absolute;
      overflow: hidden;
    }
    .template {
      width: 100%;
      height: 100%;
      background-size: 100% 100%;
      background-repeat: no-repeat;
    }
  </style>

  <template>
    <!-- Screen setup requests -->
    <iron-ajax 
      id="initScreenData" 
      handle-as="json"
      on-response="handleScreenData">
    </iron-ajax>
    <iron-ajax
      id="updateScreenData"
      handle-as="json"
      on-response="setupChanged">
    </iron-ajax>
    <!-- Create template background, positions, and fields -->
    <template is="dom-if" if="{{template.id}}">
      <div id="{{templateId(template.id)}}" class="template"
        style$="{{backgroundImage(template.path)}}">
        <template is="dom-repeat" items="{{template.positions}}" as="position">
          <div class="position" id="{{positionId(position.id)}}"
            style$="{{computeFieldPosition(position)}}">
            <concerto-field screen-id="{{screenId}}"
              field-id="{{position.field.id}}"
              field-name="{{position.field.name}}"
              base-url="{{baseUrl}}"
              content-style="{{position.style}}"
              opt-config="{{position.field.config}}">
            </concerto-field>
          </div>
        </template>
      </div>
    </template>
  </template>

  <script>
    Polymer({
      is: "concerto-screen",

      behaviors: [ConcertoBehaviors.Utils],

      properties: {
        screenId: Number,
        baseUrl: String,
        name: String,
        template: Object
      },

      ready: function() {
        /* get intial screen data and check for changes periodically */
        var setup = this.baseUrl + "/frontend/" + this.screenId + "/setup.json";
        this.$.initScreenData.url = setup;
        this.$.updateScreenData.url = setup;
        this.updateScreenData(this.$.initScreenData);
        setInterval(this.updateScreenData, 1000, this.$.updateScreenData);
      },

      templateId: function(id) {
        return "template_" + id;
      },  

      positionId: function(id) {
        return "position_" + id;
      },

      backgroundImage: function(path) {
        /* background-image style for annotated attribute binding */
        var url = this.resolveURL(path, this.baseUrl);
        return "background-image: url('" + url + "');";
      },

      computeFieldPosition: function(position) {
        return "left: " + position.left * 100 + "%; " +
               "top: " + position.top * 100 + "%; " + 
               "width: " + (position.right - position.left) * 100 + "%; " + 
               "height: " + (position.bottom - position.top) * 100 + "%;";
      },

      updateScreenData: function(ajax) {
        ajax.generateRequest();
      },

      handleScreenData: function(event, response) {
        /* set screen setup properties */
        var data = response.response;
        this.name = data.name;
        this.template = data.template;
      },

      setupChanged: function(event, response) {
        /* reload screen if changes are found in screen setup */
        var template = this.template;
        var response = response.response;

        /* Check for changes to screen's effective template */
        if (template.name != response.template.name) {
          location.reload();
        }

        /* Check for any changes to positions */
        for (var position in this.template.positions) {
          if (!(position in response.template.positions)) {
            location.reload();
          }
        }
      }
    });
  </script>

</dom-module>