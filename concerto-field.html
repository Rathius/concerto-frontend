<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<!--
The `concerto-field` element provides a field for a screen which manages
fetching and displaying content elements.

@element concerto-field
@status alpha
-->
<polymer-element name="concerto-field" attributes="screenId fieldId baseURL contentStyle">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }

      #content {
        width: 100%;
        height: 100%;
      }
    </style>
    <core-ajax id="contentsData"
      url="{{baseURL}}/frontend/{{screenId}}/fields/{{fieldId}}/contents.json"
      handleAs="json"
      on-core-response="{{handleContentsData}}"
      on-core-error="{{handleContentsError}}"></core-ajax>
    <div id="content"></div>
  </template>

  <script>
    Polymer({
      /**
       * Backend ID of the screen.
       *
       * @attribute screenId
       * @type Number
       * @default 0
       */
      screenId: 0,

      /**
       * Backend ID of the field.
       *
       * @attribute fieldId
       * @type Number
       * @default 0
       */
      fieldId: 0,

      /**
       * Base path to prepend to all URLs.
       *
       * @attribute baseURK
       * @type String
       * @default ''
       */
      baseURL: '',

      /**
       * Styling to be set on the content elements.
       *
       * @attribute contentStyle
       * @type String
       * @default ''
       */
      contentStyle: '',

      /**
       * Content currently being shown in the field
       *
       * @attribute currentContent
       */
      currentContent: undefined,

      domReady: function(){
        this.requestContent();
      },

      requestContent: function() {
        this.$.contentsData.go();
      },

      handleContentsData: function(event, response) {
        // TODO(bamnet): Handle multiple contents being returned.
        var data = response.response[Math.floor((Math.random() * response.response.length))];
        // TODO(bamnet): Improve handling of errors.
        if (!data) {
          console.log("No content to display in field " + this.fieldId);
          return;
        }
        var contentData = {
          title: data.name,
          contentId: data.id,
          duration: data.duration,
        };

        //Flatten render_details
        Object.keys(data.render_details).forEach(function(key) {
          contentData[key] = data.render_details[key];
        });

        var contentType = data.type.toLowerCase();
        var content = concerto.contentFactory.getType(contentType);
        if (!content) {
          console.log('No content type registered for ' + contentType);
          this.scheduleUpdate(10 * 1000);  // Try again in 10 seconds.
          return;
        }
        content.baseURL = this.baseURL;
        content.cssText = this.contentStyle;
        // Setup the listeners before loading the data.
        content.addEventListener('load', this.handleContentLoaded.bind(this));
        content.fromJSON(contentData);
      },

      handleContentLoaded: function(event) {
        var content = event.detail;
        content.removeEventListener('load', this.handleContentLoaded);
        if (!this.currentContent) {
          this.$.content.appendChild(content);
        } else {
          this.$.content.replaceChild(content, this.currentContent);
        }
        this.currentContent = content;
        this.scheduleUpdate(content.duration * 1000);
      },

      handleContentsError: function(event, xhr) {
        console.log('Error retrieving content data for field ' + this.fieldId);
        this.scheduleUpdate(30 * 1000); // Try again in 30 seconds.
      },

      scheduleUpdate: function(msToWait) {
        this.job('updateField' + this.fieldId, function() {
          this.requestContent();
        }, msToWait);
      },
    });
  </script>
</polymer-element>
